import React, { useEffect, useMemo, useState } from "react";

/**
 * 80%-Pass Tracker — Cohort Score Calculator
 *
 * Weights (fixed by program):
 *  - Bi-Weekly Quizzes .......... 15 pts total (each quiz scored /20; average quiz % × 15)
 *  - Final Exam ................. 25 pts (final % × 25)
 *  - Tutor Grading .............. 20 pts (assignments + participation + questions) (tutor % × 20)
 *  - Capstone Project ........... 35 pts (capstone % × 35)
 *  - Compliance .................  5 pts (compliance % × 5)
 *  Pass threshold: 80 pts aggregate.
 *
 * This single-file React component uses Tailwind classes provided by the host app.
 * It stores state in localStorage so you can keep updating scores over the weeks.
 */

const STORAGE_KEY = "pass-tracker-state-v1";

function number(v: any, def = 0) {
  const n = Number(v);
  return Number.isFinite(n) ? n : def;
}

function clamp01(x: number) {
  if (Number.isNaN(x)) return 0;
  if (x < 0) return 0;
  if (x > 1) return 1;
  return x;
}

function SectionCard({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <div className="bg-white rounded-2xl shadow p-5 border border-gray-100">
      <h2 className="text-lg font-semibold mb-3">{title}</h2>
      {children}
    </div>
  );
}

function Stat({ label, value, hint }: { label: string; value: string; hint?: string }) {
  return (
    <div className="flex items-start justify-between py-2">
      <div className="text-gray-600">{label}</div>
      <div className="text-right">
        <div className="font-semibold">{value}</div>
        {hint ? <div className="text-xs text-gray-400">{hint}</div> : null}
      </div>
    </div>
  );
}

export default function App() {
  const [quizzes, setQuizzes] = useState<number[]>([0]); // raw scores out of 20
  const [finalPct, setFinalPct] = useState<number>(0); // 0-100
  const [tutorPct, setTutorPct] = useState<number>(0); // 0-100
  const [capstonePct, setCapstonePct] = useState<number>(0); // 0-100
  const [compliancePct, setCompliancePct] = useState<number>(0); // 0-100

  // Which buckets are still remaining (for required-average calc)
  const [remaining, setRemaining] = useState({
    quizzes: false,
    final: true,
    tutor: true,
    capstone: true,
    compliance: true,
  });

  // Load / Save
  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const s = JSON.parse(raw);
        if (Array.isArray(s.quizzes)) setQuizzes(s.quizzes.map((x: any) => number(x, 0)));
        setFinalPct(number(s.finalPct, 0));
        setTutorPct(number(s.tutorPct, 0));
        setCapstonePct(number(s.capstonePct, 0));
        setCompliancePct(number(s.compliancePct, 0));
        if (s.remaining) setRemaining({ ...remaining, ...s.remaining });
      }
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    const payload = {
      quizzes,
      finalPct,
      tutorPct,
      capstonePct,
      compliancePct,
      remaining,
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }, [quizzes, finalPct, tutorPct, capstonePct, compliancePct, remaining]);

  // --- Scoring math ---
  const quizAvgPct = useMemo(() => {
    if (!quizzes.length) return 0;
    const percents = quizzes.map((s) => clamp01(number(s, 0) / 20));
    const avg = percents.reduce((a, b) => a + b, 0) / percents.length;
    return avg * 100; // 0..100
  }, [quizzes]);

  const quizPoints = (quizAvgPct / 100) * 15; // 15-pt bucket
  const finalPoints = clamp01(finalPct / 100) * 25;
  const tutorPoints = clamp01(tutorPct / 100) * 20;
  const capstonePoints = clamp01(capstonePct / 100) * 35;
  const compliancePoints = clamp01(compliancePct / 100) * 5;

  const totalPoints = quizPoints + finalPoints + tutorPoints + capstonePoints + compliancePoints;
  const pass = totalPoints >= 80;

  // Remaining capacity & requirement
  const remainingCapacity =
    (remaining.quizzes ? 15 : 0) +
    (remaining.final ? 25 : 0) +
    (remaining.tutor ? 20 : 0) +
    (remaining.capstone ? 35 : 0) +
    (remaining.compliance ? 5 : 0);

  const pointsNeeded = Math.max(0, 80 - totalPoints);
  const requiredAvgOnRemaining = remainingCapacity > 0 ? (pointsNeeded / remainingCapacity) * 100 : 0;

  // Helper to render an input with label
  const Input = ({
    label,
    value,
    onChange,
    suffix = "%",
    step = 1,
  }: {
    label: string;
    value: number;
    onChange: (n: number) => void;
    suffix?: string;
    step?: number;
  }) => (
    <label className="flex items-center justify-between py-2">
      <span className="text-gray-600 mr-3">{label}</span>
      <span className="flex items-center">
        <input
          type="number"
          value={Number.isFinite(value) ? value : 0}
          onChange={(e) => onChange(number(e.target.value, 0))}
          className="w-28 border rounded-lg px-3 py-2 text-right"
          step={step}
        />
        <span className="ml-2 text-gray-500">{suffix}</span>
      </span>
    </label>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-5xl mx-auto p-6">
        <header className="mb-6">
          <h1 className="text-2xl font-bold">80% Pass Tracker</h1>
          <p className="text-gray-600 mt-1">
            Enter your scores. The tool applies the official weights and tells you if you meet the 80-point
            threshold, how many points you still need, and what average you must score on remaining components.
          </p>
        </header>

        <div className="grid md:grid-cols-2 gap-5">
          <SectionCard title="Bi‑Weekly Quizzes (15 pts total)">
            <p className="text-sm text-gray-500 mb-2">
              Add each quiz score <span className="font-medium">out of 20</span>. We average the quiz percentages and
              convert that into the 15‑point bucket.
            </p>
            <div className="space-y-2">
              {quizzes.map((q, i) => (
                <div key={i} className="flex items-center gap-2">
                  <input
                    type="number"
                    min={0}
                    max={20}
                    step={0.5}
                    value={Number.isFinite(q) ? q : 0}
                    onChange={(e) => {
                      const v = number(e.target.value, 0);
                      const arr = [...quizzes];
                      arr[i] = v;
                      setQuizzes(arr);
                    }}
                    className="w-28 border rounded-lg px-3 py-2 text-right"
                  />
                  <span className="text-gray-500">/ 20</span>
                  <button
                    onClick={() => setQuizzes(quizzes.filter((_, idx) => idx !== i))}
                    className="ml-auto text-sm text-red-600 hover:underline"
                    disabled={quizzes.length === 1}
                    title={quizzes.length === 1 ? "Keep at least one row" : "Remove quiz"}
                  >
                    Remove
                  </button>
                </div>
              ))}
              <div className="flex gap-2 mt-2">
                <button
                  onClick={() => setQuizzes([...quizzes, 0])}
                  className="px-3 py-1.5 rounded-lg bg-gray-900 text-white text-sm"
                >
                  + Add quiz
                </button>
                <button
                  onClick={() => setQuizzes([0])}
                  className="px-3 py-1.5 rounded-lg bg-white border text-sm"
                >
                  Reset quizzes
                </button>
              </div>
            </div>
            <div className="mt-4 border-t pt-3">
              <Stat label="Average quiz %" value={`${quizAvgPct.toFixed(1)}%`} />
              <Stat label="Points from quizzes" value={`${quizPoints.toFixed(2)} / 15`} />
            </div>
          </SectionCard>

          <SectionCard title="Final Exam (25 pts)">
            <Input label="Final exam %" value={finalPct} onChange={setFinalPct} />
            <div className="mt-2 border-t pt-3">
              <Stat label="Points from final" value={`${finalPoints.toFixed(2)} / 25`} />
            </div>
          </SectionCard>

          <SectionCard title="Tutor Grading (20 pts)">
            <p className="text-sm text-gray-500 mb-2">
              Includes assignments, participation and questions. Enter your current/expected percentage from your tutor.
            </p>
            <Input label="Tutor grading %" value={tutorPct} onChange={setTutorPct} />
            <div className="mt-2 border-t pt-3">
              <Stat label="Points from tutor grading" value={`${tutorPoints.toFixed(2)} / 20`} />
            </div>
          </SectionCard>

          <SectionCard title="Capstone Project (35 pts)">
            <Input label="Capstone %" value={capstonePct} onChange={setCapstonePct} />
            <div className="mt-2 border-t pt-3">
              <Stat label="Points from capstone" value={`${capstonePoints.toFixed(2)} / 35`} />
            </div>
          </SectionCard>

          <SectionCard title="Compliance (5 pts)">
            <p className="text-sm text-gray-500 mb-2">Deadline/instruction compliance percentage.</p>
            <Input label="Compliance %" value={compliancePct} onChange={setCompliancePct} />
            <div className="mt-2 border-t pt-3">
              <Stat label="Points from compliance" value={`${compliancePoints.toFixed(2)} / 5`} />
            </div>
          </SectionCard>

          <SectionCard title="Progress & Requirements">
            <div className="grid grid-cols-1 gap-2">
              <div className="rounded-xl bg-gray-50 p-3 border text-sm">
                <div className="flex items-center justify-between">
                  <span>Total points so far</span>
                  <span className="font-semibold">{totalPoints.toFixed(2)} / 100</span>
                </div>
                <div className="mt-2">
                  <div className={`inline-flex items-center px-2 py-1 rounded-lg text-xs ${
                    pass ? "bg-green-100 text-green-700" : "bg-yellow-100 text-yellow-800"
                  }`}>
                    {pass ? "On track: ≥ 80" : "Below 80 — keep pushing"}
                  </div>
                </div>
              </div>

              <div className="rounded-xl bg-white p-3 border">
                <div className="text-sm font-medium mb-2">What do I still need?</div>
                <Stat label="Points needed to reach 80" value={`${pointsNeeded.toFixed(2)}`} />
                <div className="text-xs text-gray-500 mb-2">Select which components are still remaining:</div>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  {[
                    { key: "quizzes", label: "Quizzes (15)" },
                    { key: "final", label: "Final (25)" },
                    { key: "tutor", label: "Tutor (20)" },
                    { key: "capstone", label: "Capstone (35)" },
                    { key: "compliance", label: "Compliance (5)" },
                  ].map((opt) => (
                    <label key={opt.key} className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={(remaining as any)[opt.key]}
                        onChange={(e) => setRemaining({ ...remaining, [opt.key]: e.target.checked })}
                      />
                      <span>{opt.label}</span>
                    </label>
                  ))}
                </div>
                <div className="mt-3 border-t pt-3">
                  <Stat
                    label="Remaining capacity"
                    value={`${remainingCapacity.toFixed(2)} pts`}
                    hint="Sum of maximum points still on the table for selected components"
                  />
                  <Stat
                    label="Required average across remaining"
                    value={`${Math.min(100, Math.max(0, requiredAvgOnRemaining)).toFixed(1)}%`}
                    hint="If you score at least this average across the selected remaining components, you'll reach 80."
                  />
                </div>
              </div>
            </div>
          </SectionCard>
        </div>

        <footer className="mt-6 text-xs text-gray-400">
          Built for quick cohort tracking. All calculations are transparent and based on the official weights.
        </footer>
      </div>
    </div>
  );
}
